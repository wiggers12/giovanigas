<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Gigas</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="manifest" href="./manifest.webmanifest">
    <meta name="theme-color" content="#004AAD">
    <link rel="apple-touch-icon" href="icons/icon-192.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="Gigas">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">

    <style>
        :root{
            --gigas-blue:#004AAD; --gigas-blue-light:#E0F2FE; --gigas-blue-dark:#00307A;
            --gigas-red:#D93025;
            --bg-light:#F4F6F9; --bg-dark:#F4F6F9; --bg-dark-card:#FFFFFF;
            --text-primary:#222; --text-secondary:#666; --border-color:#DDD;
            --shadow:0 4px 10px rgba(0,0,0,0.1); --border-radius:12px;
            --primary-hover:#003d8b;
        }
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Inter',sans-serif;background:var(--bg-dark);color:var(--text-primary)}
        main{display:none}

        /* Splash */
        #splashScreen{position:fixed;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;background:linear-gradient(135deg,#3a7dff,#5c9bff);color:#fff;z-index:9999;transition:opacity 1s ease;text-align:center;padding:24px}
        #splashScreen i{font-size:4rem;margin-bottom:18px;animation:bounce 1.6s infinite}
        #splashScreen h1{font-size:2.6rem;font-weight:800;letter-spacing:2px;text-transform:uppercase}
        @keyframes bounce{0%,100%{transform:translateY(0)}50%{transform:translateY(-10px)}}

        /* Visibilidade das telas (for√ßado) */
        .screen{display:none !important;}
        .screen.active{display:block !important;animation:fadeIn .6s}
        @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}

        /* Cards/form */
        .login-body-wrapper{display:flex;align-items:center;justify-content:center;min-height:100vh;background-image:linear-gradient(135deg,#f5f7fa 0%,#c3cfe2 100%)}
        .card{background:var(--bg-dark-card);padding:30px;border-radius:var(--border-radius);border:1px solid var(--border-color);box-shadow:var(--shadow);max-width:420px;width:92vw}
        .card-header{text-align:center;margin-bottom:25px}
        .card-header h2{font-size:2em;margin-bottom:5px;color:var(--gigas-blue)}
        .form-group{margin-bottom:20px;text-align:left}
        .form-group label{display:block;margin-bottom:8px;font-weight:500;color:var(--text-secondary)}
        .form-group input, .registro-grid select, .registro-grid textarea{width:100%;padding:12px;background:var(--bg-light);border:1px solid var(--border-color);border-radius:8px;color:var(--text-primary);font-size:1em}
        button{width:100%;padding:14px;margin-top:10px;background:var(--gigas-blue);color:#fff;border:none;border-radius:8px;font-size:1.1em;font-weight:700;cursor:pointer;transition:all .3s}
        button:hover{background:var(--gigas-blue-dark);transform:translateY(-2px)}
        button:disabled{background:#999;cursor:not-allowed}
        .toggle-form{text-align:center;margin-top:20px;color:var(--text-secondary)}
        .toggle-form span{color:var(--gigas-blue);font-weight:700;cursor:pointer;text-decoration:underline}
        .registro-grid { display:grid; gap:12px; grid-template-columns:1fr; }
        @media(min-width:640px){ .registro-grid{ grid-template-columns:1fr 1fr; } }
        .registro-grid .col-span-2 { grid-column:span 2; }

        /* Promo no login */
        #promoSection{display:none;margin-bottom:25px;text-align:center;transition:opacity .5s ease-in;opacity:0}
        #promoImage{width:100%;max-height:200px;object-fit:cover;border-radius:12px;box-shadow:var(--shadow)}

        /* Cabe√ßalho App */
        .app-header{position:sticky;top:0;z-index:50;background:#fff;border-bottom:1px solid var(--border-color)}
        .app-header-inner{max-width:1200px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;padding:10px 12px}
        .brand{display:flex;align-items:center;gap:10px;font-weight:800;color:var(--gigas-blue)}
        .brand i{font-size:1.25rem}
        .top-nav{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
        .top-link{display:flex;align-items:center;gap:8px;padding:8px 12px;border-radius:8px;text-decoration:none;color:var(--text-secondary);font-weight:600;border:1px solid transparent}
        .top-link:hover{background:var(--gigas-blue-light);color:var(--gigas-blue)}
        .top-link.active{background:var(--gigas-blue);color:#fff}
        .logout-btn{background:transparent;border:1px solid var(--border-color);color:var(--text-primary);padding:8px 12px;border-radius:8px;cursor:pointer;font-weight:700}
        .logout-btn:hover{border-color:var(--gigas-red);color:var(--gigas-red)}
        .hamburger{display:none;background:transparent;border:none;font-size:1.25rem;cursor:pointer;padding:8px;color:var(--text-primary)}

        /* Responsivo: menu colaps√°vel no mobile */
        @media (max-width: 768px){
            .top-nav{display:none}
            .top-nav.open{
                position:absolute; left:8px; right:8px; top:58px;
                background:#fff; border:1px solid var(--border-color); border-radius:12px;
                padding:8px; display:flex; flex-direction:column; z-index:55;
            }
            .hamburger{display:inline-flex}
            .logout-btn{width:100%}
        }

        /* Conte√∫do App */
        .app-main{max-width:1200px;margin:0 auto;padding:14px 12px}
        .main-header h1{font-size:1.4rem;font-weight:800;margin-bottom:4px}
        .main-header p{color:var(--text-secondary)}

        /* Toast */
        .toast{position:fixed;bottom:-100px;left:50%;transform:translateX(-50%);padding:12px 25px;border-radius:12px;background:var(--gigas-blue);color:#fff;box-shadow:var(--shadow);font-weight:500;transition:bottom .5s,opacity .5s;opacity:0;z-index:1000}
        .toast.show{bottom:30px;opacity:1}
        .toast.error{background:var(--gigas-red)}

        /* Carrinho */
        #carrinho-flutuante{position:fixed;bottom:20px;right:20px;background:var(--gigas-blue);color:#fff;padding:14px 18px;border-radius:999px;cursor:pointer;box-shadow:0 6px 16px rgba(0,0,0,.18);display:none;z-index:60}
        #carrinho-flutuante:hover{transform:scale(1.06);background:var(--gigas-blue-dark)}
        #contador-carrinho{position:absolute;top:-6px;right:-6px;background:var(--gigas-red);color:#fff;font-size:.75rem;font-weight:800;padding:.2rem .45rem;border-radius:999px}
        .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.7);display:none;justify-content:center;align-items:center;z-index:70}
        .modal-overlay.active{display:flex}
        .modal-content{background:#fff;padding:1.25rem;border-radius:1rem;max-width:560px;width:92vw;max-height:80vh;overflow:auto;box-shadow:0 10px 24px rgba(0,0,0,.25)}
        .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
        .modal-header h3{font-size:1.2rem;font-weight:800}
        .close-btn{background:transparent;border:none;font-size:1.2rem;cursor:pointer}
        .cart-item{display:flex;gap:10px;padding:10px 6px;border-bottom:1px solid #eee}
        .cart-item img{width:64px;height:64px;object-fit:cover;border-radius:8px;border:1px solid #eee}
        .cart-foot{display:flex;justify-content:space-between;align-items:center;margin-top:10px;font-weight:800;flex-wrap:wrap;gap:10px;}
        .cart-foot .btn-primary { flex:1; min-width: 150px; }
        .btn-primary{background:var(--gigas-blue);border:none;color:#fff;padding:10px 14px;border-radius:8px;font-weight:800;cursor:pointer}
        .btn-primary:hover{background:var(--gigas-blue-dark)}

        /* Ajustes de toque no mobile */
        @media (max-width: 480px){
            #carrinho-flutuante{right:14px;bottom:14px;padding:12px 14px}
            .card{padding:20px}
            .form-group input{padding:12px}
            button{padding:12px}
        }

        /* ===== Carrossel de produtos ===== */
        .prod-carousel-viewport{
            overflow-x:auto; scroll-behavior:smooth; -webkit-overflow-scrolling:touch;
            scroll-snap-type:x mandatory;
        }
        .prod-carousel-track{ display:flex; gap:16px; padding:4px 2px 8px 2px; }
        .prod-card{ scroll-snap-align:center; flex:0 0 82%; }
        @media (min-width:640px){ .prod-card{ flex-basis:46%; } }
        @media (min-width:1024px){ .prod-card{ flex-basis:32%; } }
        .carousel-btn{
            position:absolute; top:50%; transform:translateY(-50%);
            background:#004AAD; color:#fff; border:none; border-radius:999px;
            width:42px; height:42px; display:flex; align-items:center; justify-content:center;
            box-shadow:0 8px 18px rgba(0,0,0,.25); opacity:.9; z-index:5;
        }
        .carousel-btn:hover{ opacity:1 }
        .carousel-prev{ left:4px } .carousel-next{ right:4px }
    </style>
</head>
<body>
    <div id="splashScreen" aria-hidden="true">
        <i class="fas fa-truck-moving"></i><h1>Gigas</h1>
    </div>

    <main>
        <section id="loginSection" class="screen login-body-wrapper active">
            <div class="card">
                <div class="card-header">
                    <h2>Bem-vindo √† Gigas!</h2>
                    <p id="loginMessage">Sua gest√£o de entregas come√ßa aqui.</p>
                </div>

                <div id="promoSection">
                    <img id="promoImage" src="" alt="Promo√ß√£o do dia"/>
                </div>

                <form id="loginForm">
                    <div class="form-group">
                        <label for="loginEmail">E-mail</label>
                        <input type="email" id="loginEmail" required>
                    </div>
                    <div class="form-group">
                        <label for="loginPassword">Senha</label>
                        <input type="password" id="loginPassword" required>
                    </div>
                    <button type="submit">Entrar</button>
                </form>
                <p class="toggle-form">N√£o tem uma conta? <span id="showRegister">Registre-se</span></p>
            </div>
        </section>

        <section id="registerSection" class="screen login-body-wrapper">
            <div class="card">
                <div class="card-header">
                    <h2>Crie sua Conta</h2>
                    <p>√â r√°pido e f√°cil</p>
                </div>
                <form id="registerForm" class="registro-grid">
                    <div class="form-group col-span-2">
                        <label for="registerName">Nome completo</label>
                        <input type="text" id="registerName" required>
                    </div>
                    <div class="form-group col-span-2">
                        <label for="registerEmail">E-mail</label>
                        <input type="email" id="registerEmail" required>
                    </div>
                    <div class="form-group col-span-2">
                        <label for="registerPassword">Senha</label>
                        <input type="password" id="registerPassword" minlength="6" required>
                    </div>
                    <div class="form-group">
                        <label for="registerTelefone">Telefone / WhatsApp</label>
                        <input type="tel" id="registerTelefone">
                    </div>
                    <div class="form-group">
                        <label for="registerCEP">CEP</label>
                        <input type="text" id="registerCEP" placeholder="00000-000">
                    </div>
                    <div class="form-group">
                        <label for="registerLogradouro">Logradouro (Rua/Avenida)</label>
                        <input type="text" id="registerLogradouro">
                    </div>
                    <div class="form-group">
                        <label for="registerNumero">N√∫mero</label>
                        <input type="text" id="registerNumero">
                    </div>
                    <div class="form-group">
                        <label for="registerBairro">Bairro</label>
                        <input type="text" id="registerBairro">
                    </div>
                    <div class="form-group">
                        <label for="registerCidade">Cidade</label>
                        <input type="text" id="registerCidade">
                    </div>
                    <div class="form-group">
                        <label for="registerEstado">Estado (UF)</label>
                        <input type="text" id="registerEstado">
                    </div>
                    <div class="form-group col-span-2">
                        <label for="registerTipoEndereco">Tipo do Endere√ßo</label>
                        <select id="registerTipoEndereco">
                            <option value="Residencial">Residencial</option>
                            <option value="Comercial">Comercial</option>
                        </select>
                    </div>
                    <div class="form-group col-span-2">
                        <label for="registerObservacoes">Observa√ß√µes (opcional)</label>
                        <textarea id="registerObservacoes" rows="2" placeholder="Pontos de refer√™ncia, etc."></textarea>
                    </div>
                    <button type="submit" class="md:col-span-2 mt-4">Cadastrar</button>
                </form>
                <p class="toggle-form">J√° tem uma conta? <span id="showLogin">Fa√ßa Login</span></p>
            </div>
        </section>

        <section id="appSection" class="screen">
            <header class="app-header">
                <div class="app-header-inner">
                    <div class="brand">
                        <button id="menuToggle" class="hamburger" aria-label="Abrir menu"><i class="fas fa-bars"></i></button>
                        <i class="fas fa-truck-moving"></i><span>Gigas</span>
                    </div>
                    <nav id="topNav" class="top-nav" aria-label="Navega√ß√£o principal">
                        <a class="top-link active" href="#"><i class="fas fa-store"></i>Cat√°logo</a>
                        <a class="top-link" href="pedidos.html"><i class="fas fa-receipt"></i>Pedidos</a>
                        <a class="top-link" href="area.do.cliente.html"><i class="fas fa-user-circle"></i>√Årea do Cliente</a>
                        <a class="top-link" href="admin.html"><i class="fas fa-user-shield"></i> Admin</a>
                        <a class="top-link" href="qrcode.html"><i class="fas fa-qrcode"></i>QR-CODE</a>
                        <button id="logoutBtn" class="logout-btn"><i class="fas fa-sign-out-alt"></i> Sair</button>
                    </nav>
                </div>
            </header>

            <div class="app-main">
                <div class="main-header">
                    <h1 id="welcomeMessage">Ol√°!</h1>
                    <p>Confira nossos produtos e fa√ßa seu pedido diretamente pelo cat√°logo.</p>
                </div>

                <div class="relative">
                    <button id="prevProd" class="carousel-btn carousel-prev" aria-label="Anterior">‚Äπ</button>
                    <button id="nextProd" class="carousel-btn carousel-next" aria-label="Pr√≥ximo">‚Ä∫</button>

                    <div id="produtosViewport" class="prod-carousel-viewport">
                        <div id="produtosTrack" class="prod-carousel-track"></div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <div id="carrinho-flutuante"><i class="fas fa-shopping-cart"></i> <span style="margin-left:8px">Carrinho</span><span id="contador-carrinho">0</span></div>
    <div id="carrinhoModal" class="modal-overlay" aria-modal="true" role="dialog">
        <div class="modal-content">
            <div class="modal-header"><h3>Seu Carrinho</h3><button class="close-btn" id="closeCarrinho" aria-label="Fechar carrinho"><i class="fas fa-times"></i></button></div>
            <div id="cartBody"></div>
            <div class="cart-foot">
                <div>Total: <span id="cartTotal">R$ 0,00</span></div>
                <button class="btn-primary" id="pagarPixManual" aria-label="Pagar via Pix"><i class="fas fa-qrcode"></i> Pagar via Pix</button>
                <button class="btn-primary" id="finalizarPedido"><i class="fas fa-check"></i> Finalizar pedido</button>
            </div>
        </div>
    </div>
    <div id="pixModal" class="modal-overlay" aria-modal="true" role="dialog">
      <div class="modal-content">
        <div class="modal-header"><h3>Pagamento via Pix</h3><button class="close-btn" id="closePixModal"><i class="fas fa-times"></i></button></div>
        <p>Use a chave Pix abaixo para realizar o pagamento:</p>
        <div style="background:#f1f1f1;padding:10px;border-radius:8px;margin-top:10px;display:flex;justify-content:space-between;align-items:center;">
          <span id="pixKeyText" style="font-weight:700">519894488058</span>
          <button id="copyPixKey" class="btn-primary" style="padding:6px 10px;font-size:.9em;">Copiar</button>
        </div>
        <p style="margin-top:10px;font-weight:600">Valor: <span id="pixValor" style="color:#004AAD"></span></p>
        <button id="confirmarPagamento" class="btn-primary" style="margin-top:15px;width:100%;">J√° realizei o pagamento</button>
      </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, collection, addDoc, serverTimestamp, query, where, getDocs, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

        // Configura√ß√£o e Inicializa√ß√£o do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyC4h0J54TZqT8XXUsPSL3_ABVJQ05yP4Hc",
            authDomain: "giovanigas-d959b.firebaseapp.com",
            projectId: "giovanigas-d959b",
            storageBucket: "giovanigas-d959b.firebasestorage.app",
            messagingSenderId: "728326355548",
            appId: "1:728326355548:web:9dda06e1c1148337618499",
            measurementId: "G-ESHC9P6XGZ"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // =======================================================
        // DECLARA√á√ïES DE VARI√ÅVEIS E FUN√á√ïES GLOBAIS
        // =======================================================
        const loginMessages = [
            "Sua gest√£o de entregas come√ßa aqui.",
            "Bem-vindo de volta! Fa√ßa seu login.",
            "Tudo que voc√™ precisa em um s√≥ lugar.",
            "O futuro do seu neg√≥cio est√° aqui."
        ];
        let msgIndex = 0;
        const loginMessageEl = document.getElementById('loginMessage');
        const promoSectionEl = document.getElementById('promoSection');
        const promoImageEl = document.getElementById('promoImage');

        const sections = {
            login: document.getElementById('loginSection'),
            register: document.getElementById('registerSection'),
            app: document.getElementById('appSection')
        };
        const welcomeMessage = document.getElementById('welcomeMessage');
        const topNav = document.getElementById('topNav');
        const menuToggle = document.getElementById('menuToggle');

        const produtosTrack = document.getElementById('produtosTrack');
        const produtosViewport = document.getElementById('produtosViewport');
        const prevBtn = document.getElementById('prevProd');
        const nextBtn = document.getElementById('nextProd');
        const carrinhoBtn = document.getElementById('carrinho-flutuante');
        const contadorCarrinho = document.getElementById('contador-carrinho');
        const carrinhoModal = document.getElementById('carrinhoModal');
        const closeCarrinho = document.getElementById('closeCarrinho');
        const cartBody = document.getElementById('cartBody');
        const cartTotal = document.getElementById('cartTotal');
        const finalizarPedido = document.getElementById('finalizarPedido');
        const pagarPixManual = document.getElementById('pagarPixManual');

        const pixModal = document.getElementById('pixModal');
        const closePixModal = document.getElementById('closePixModal');
        const pixKeyText = document.getElementById('pixKeyText');
        const copyPixKey = document.getElementById('copyPixKey');
        const pixValor = document.getElementById('pixValor');
        const confirmarPagamento = document.getElementById('confirmarPagamento');

        let cart = [];
        let userAuth = null;
        let pedidoAtualID = null; // Vari√°vel cr√≠tica para o fluxo Pix
        const fmtBRL = v => (Number(v)||0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});

        // =======================================================
        // FUN√á√ïES DE UTILIDADE (Toast, Navega√ß√£o de Se√ß√£o, Splash)
        // =======================================================
        function showToast(msg,type='success'){
            const t=document.createElement('div');
            t.className=`toast ${type==='error'?'error':''}`;
            t.textContent=msg; document.body.appendChild(t);
            setTimeout(()=>{t.classList.add('show'); setTimeout(()=>{t.classList.remove('show'); t.addEventListener('transitionend',()=>t.remove());},3000)},10);
        }

        function showSection(key){
            Object.values(sections).forEach(s=>s.classList.remove('active'));
            sections[key].classList.add('active');
        }

        function updateLoginMessage(){
            loginMessageEl.textContent = loginMessages[msgIndex];
            msgIndex = (msgIndex + 1) % loginMessages.length;
        }
        setInterval(updateLoginMessage,5000); updateLoginMessage();

        // =======================================================
        // EVENTOS DE NAVEGA√á√ÉO E AUTENTICA√á√ÉO
        // =======================================================
        onAuthStateChanged(auth, async (user)=>{
            userAuth = user; // Atualiza a vari√°vel de autentica√ß√£o
            if(user){
                let nome = '';
                const snap = await getDoc(doc(db,'clientes',user.uid));
                if (snap.exists() && snap.data().nome) {
                    nome = snap.data().nome.split(' ')[0];
                } else {
                    const qAntigo = query(collection(db, 'clientes_cadastros'), where('email', '==', user.email));
                    const snapAntigo = await getDocs(qAntigo);
                    if (!snapAntigo.empty) {
                        const docAntigo = snapAntigo.docs[0].data();
                        if (docAntigo.nomeCompleto) {
                            nome = docAntigo.nomeCompleto.split(' ')[0];
                        }
                    }
                }
                welcomeMessage.textContent = nome ? `Ol√°, ${nome}!` : 'Ol√°!';
                showSection('app');
            }else{
                showSection('login');
            }
        });

        // Toggle do Menu Mobile
        menuToggle?.addEventListener('click', ()=>{
            topNav.classList.toggle('open');
            menuToggle.setAttribute('aria-expanded', topNav.classList.contains('open') ? 'true' : 'false');
        });

        // Promo do Login
        onSnapshot(doc(db,"configuracoes","promo_login"), snap=>{
            if(snap.exists() && snap.data().promoImage){
                promoImageEl.src = snap.data().promoImage;
                promoSectionEl.style.display = 'block';
                setTimeout(()=>promoSectionEl.style.opacity='1',50);
            }else{
                promoSectionEl.style.display = 'none';
            }
        });

        // Form Login
        document.getElementById('loginForm').addEventListener('submit', async (e)=>{
            e.preventDefault();
            const btn=e.target.querySelector('button');
            btn.disabled=true; btn.textContent='Entrando...';
            try{
                await signInWithEmailAndPassword(auth, e.target.loginEmail.value, e.target.loginPassword.value);
            }catch(err){
                showToast(err.code==='auth/invalid-credential'?'E-mail ou senha inv√°lidos.':'Erro ao fazer login.','error');
            }finally{
                btn.disabled=false; btn.textContent='Entrar';
            }
        });

        // Form Registro
        document.getElementById('registerForm').addEventListener('submit', async (e)=>{
            e.preventDefault();
            const btn=e.target.querySelector('button');
            btn.disabled=true; btn.textContent='Cadastrando...';
            try{
                const { registerName, registerEmail, registerPassword, registerTelefone, registerCEP, registerLogradouro, registerNumero, registerBairro, registerCidade, registerEstado, registerTipoEndereco, registerObservacoes } = e.target;
                const cred = await createUserWithEmailAndPassword(auth, registerEmail.value, registerPassword.value);
                await setDoc(doc(db,'clientes',cred.user.uid),{
                    nome: registerName.value,
                    email: registerEmail.value,
                    telefone: registerTelefone.value,
                    endereco: {
                        cep: registerCEP.value,
                        logradouro: registerLogradouro.value,
                        numero: registerNumero.value,
                        bairro: registerBairro.value,
                        cidade: registerCidade.value,
                        estado: registerEstado.value,
                        tipo: registerTipoEndereco.value
                    },
                    observacoes: registerObservacoes.value,
                    criadoEm: serverTimestamp(),
                    pontosFidelidade: 0
                });
                showToast('Usu√°rio registrado com sucesso!');
                showSection('login');
            }catch(err){
                console.error(err);
                showToast('Erro ao cadastrar. Verifique os dados.','error');
            }finally{
                btn.disabled=false; btn.textContent='Cadastrar';
            }
        });
        
        // Auto-preencher por CEP
        document.getElementById('registerCEP').addEventListener('blur', async (e) => {
            const cep = e.target.value.replace(/\D/g, '');
            if (cep.length === 8) {
                try {
                    const response = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
                    const data = await response.json();
                    if (!data.erro) {
                        document.getElementById('registerLogradouro').value = data.logradouro || '';
                        document.getElementById('registerBairro').value = data.bairro || '';
                        document.getElementById('registerCidade').value = data.localidade || '';
                        document.getElementById('registerEstado').value = data.uf || '';
                        document.getElementById('registerNumero').focus();
                    } else {
                        showToast('CEP n√£o encontrado.', 'error');
                    }
                } catch (error) {
                    showToast('Erro ao buscar CEP. Tente novamente.', 'error');
                }
            }
        });

        document.getElementById('showRegister').addEventListener('click',()=>showSection('register'));
        document.getElementById('showLogin').addEventListener('click',()=>showSection('login'));
        document.getElementById('logoutBtn').addEventListener('click',()=>{
            signOut(auth);
            topNav.classList.remove('open');
        });

        // =======================================================
        // L√ìGICA DO CARRINHO
        // =======================================================
        function atualizarBadge(){
            const q = cart.reduce((acc,i)=>acc+i.qty,0);
            contadorCarrinho.textContent = q;
            carrinhoBtn.style.display = q>0 ? 'inline-flex' : 'none';
        }

        function renderCart(){
            cartBody.innerHTML='';
            let total=0;
            if(cart.length === 0){
                cartBody.innerHTML = '<p style="text-align:center;color:#666">O carrinho est√° vazio.</p>';
                cartTotal.textContent = fmtBRL(0);
                finalizarPedido.disabled = true;
                pagarPixManual.disabled = true;
                return;
            }
            finalizarPedido.disabled = false;
            pagarPixManual.disabled = false;
            
            cart.forEach(item=>{
                total += item.preco*item.qty;
                const row = document.createElement('div');
                row.className='cart-item';
                row.innerHTML=`
                    <img src="${item.imagem||'https://placehold.co/150'}" alt="${item.nome}">
                    <div style="flex:1">
                        <div style="font-weight:800">${item.nome}</div>
                        <div style="display:flex;gap:8px;align-items:center;margin-top:4px">
                            <button class="qmenos" aria-label="Diminuir" style="width:30px;padding:4px;margin:0;background:#ccc;color:#333">-</button>
                            <span>${item.qty}</span>
                            <button class="qmais" aria-label="Aumentar" style="width:30px;padding:4px;margin:0;background:#004AAD;color:#fff">+</button>
                            <span style="margin-left:auto;font-weight:700">${fmtBRL(item.preco*item.qty)}</span>
                        </div>
                    </div>
                `;
                row.querySelector('.qmenos').addEventListener('click',()=>{
                    item.qty = Math.max(0,item.qty-1);
                    if(item.qty===0) cart = cart.filter(x=>x.id!==item.id);
                    atualizarBadge(); renderCart();
                });
                row.querySelector('.qmais').addEventListener('click',()=>{
                    item.qty += 1; atualizarBadge(); renderCart();
                });
                cartBody.appendChild(row);
            });
            cartTotal.textContent = fmtBRL(total);
        }

        function abrirCarrinho(){ renderCart(); carrinhoModal.classList.add('active'); }
        function fecharCarrinho(){ carrinhoModal.classList.remove('active'); }
        carrinhoBtn.addEventListener('click', abrirCarrinho);
        closeCarrinho.addEventListener('click', fecharCarrinho);
        carrinhoModal.addEventListener('click', (e)=>{ if(e.target === carrinhoModal){ fecharCarrinho(); }});
        document.addEventListener('keydown', (e)=>{ if(e.key === 'Escape'){ fecharCarrinho(); }});
        
        function adicionarAoCarrinho(prod){
            if(!userAuth){ 
                showToast('Fa√ßa login para adicionar produtos ao carrinho.', 'error'); 
                return; 
            }
            const found = cart.find(i=>i.id===prod.id);
            if(found){ found.qty += 1; }
            else{ cart.push({ id:prod.id, nome:prod.nome, preco:Number(prod.preco)||0, imagem:prod.imagem||'', qty:1 }); }
            atualizarBadge();
            showToast('Produto adicionado ao carrinho!');
            renderCart();
        }

        // Finalizar Pedido (Pagamento na entrega/Outros)
        finalizarPedido.addEventListener('click', async () => {
            if (!userAuth) { showToast('Voc√™ precisa estar logado para finalizar o pedido.', 'error'); return; }
            if(cart.length===0){ showToast('Seu carrinho est√° vazio.', 'error'); return; }
            
            finalizarPedido.disabled = true;
            finalizarPedido.textContent = 'Enviando...';

            try {
                const total = cart.reduce((acc, item) => acc + item.preco * item.qty, 0);
                const pedidoPayload = {
                    userid: userAuth.uid, itens: cart, total, status: 'pendente', criadoEm: serverTimestamp()
                };
                await addDoc(collection(db, 'pedidos'), pedidoPayload);
                showToast('Pedido enviado com sucesso! Aguarde o processamento.', 'success');
                cart = []; atualizarBadge(); renderCart(); fecharCarrinho();
            } catch (error) {
                console.error("Erro ao finalizar o pedido:", error);
                showToast('Erro ao enviar o pedido. Tente novamente.', 'error');
            } finally {
                finalizarPedido.disabled = false;
                finalizarPedido.innerHTML = '<i class="fas fa-check"></i> Finalizar pedido';
            }
        });

        // =======================================================
        // L√ìGICA DO PIX MANUAL (CORRIGIDA)
        // =======================================================

        // Fun√ß√£o para fechar o modal Pix
        function fecharPixModal() {
            pixModal.classList.remove('active');
        }
        closePixModal.addEventListener('click', fecharPixModal);
        pixModal.addEventListener('click', (e) => { if (e.target === pixModal) { fecharPixModal(); } });
        document.addEventListener('keydown', (e)=>{ if(e.key === 'Escape' && pixModal.classList.contains('active')){ fecharPixModal(); }});


        // 1. ABRIR MODAL PIX (NO CARRINHO)
        pagarPixManual.addEventListener('click', async () => {
            if (!userAuth) { showToast('Voc√™ precisa estar logado para pagar via Pix.', 'error'); return; }
            if (cart.length === 0) { showToast('Seu carrinho est√° vazio.', 'error'); return; }
            
            pagarPixManual.disabled = true;
            pagarPixManual.textContent = 'Gerando...';

            try {
                // Envia o pedido como 'aguardando_pagamento_pix'
                const total = cart.reduce((acc, item) => acc + item.preco * item.qty, 0);
                const pedidoPayload = {
                    userid: userAuth.uid, itens: cart, total, status: 'aguardando_pagamento_pix', criadoEm: serverTimestamp()
                };

                const docRef = await addDoc(collection(db, 'pedidos'), pedidoPayload);
                pedidoAtualID = docRef.id; // CR√çTICO: Armazena o ID do novo pedido
                
                // Atualiza a interface do modal Pix
                pixValor.textContent = fmtBRL(total);
                fecharCarrinho(); // Fecha o modal do carrinho
                pixModal.classList.add('active');
                showToast('Pedido registrado! Prossiga com o pagamento Pix.', 'success');

            } catch (error) {
                console.error("Erro ao preparar pedido Pix:", error);
                showToast('Erro ao preparar o pedido Pix. Tente novamente.', 'error');
            } finally {
                pagarPixManual.disabled = false;
                pagarPixManual.innerHTML = '<i class="fas fa-qrcode"></i> Pagar via Pix';
            }
        });


        // 2. CONFIRMAR PAGAMENTO
        confirmarPagamento.addEventListener('click', async () => {
            if(!pedidoAtualID){ showToast('Nenhum pedido ativo para confirmar.','error'); return; }

            // Desabilita o bot√£o para evitar cliques duplicados
            confirmarPagamento.disabled = true;
            confirmarPagamento.textContent = 'Confirmando...';

            try{
                // Calcula o total novamente, para usar na mensagem do WhatsApp
                const total = cart.reduce((acc, i)=>acc + i.preco * i.qty, 0);
                
                // Atualiza o status do pedido
                await updateDoc(doc(db,'pedidos',pedidoAtualID),{
                    status:'pago',
                    confirmadoEm:serverTimestamp()
                });

                showToast('Pagamento confirmado!','success');
                
                // Busca o nome e telefone do cliente
                const snap = await getDoc(doc(db,'clientes',userAuth.uid));
                let nomeCliente = snap.exists() ? snap.data().nome.split(' ')[0] : 'cliente';
                let telefone = snap.exists() ? snap.data().telefone?.replace(/\D/g,'') : '';
                
                // Mensagem autom√°tica para WhatsApp
                const mensagem = `‚úÖ Ol√°, ${nomeCliente}!%0ARecebemos o pagamento do seu pedido *GIGAS* no valor de *${fmtBRL(total)}*.%0AObrigado pela prefer√™ncia üíô%0AAssim que estiver pronto, entraremos em contato.`;
                const linkWhats = telefone 
                    ? `https://wa.me/55${telefone}?text=${mensagem}`
                    : `https://wa.me/5551989448805?text=${mensagem}`; // fallback para WhatsApp da loja
                
                window.open(linkWhats, '_blank');

                setTimeout(()=>pixModal.classList.remove('active'),1200);
                
                // Limpa o carrinho e reseta o ID do pedido
                cart = [];
                pedidoAtualID = null; 
                atualizarBadge(); renderCart();
            }catch(e){
                console.error(e);
                showToast('Erro ao confirmar pagamento.','error');
            } finally {
                 confirmarPagamento.disabled = false;
                 confirmarPagamento.textContent = 'J√° realizei o pagamento';
            }
        });


        // 3. COPIAR CHAVE PIX
        copyPixKey.addEventListener('click', () => {
            const pixKey = pixKeyText.textContent;
            navigator.clipboard.writeText(pixKey).then(() => {
                showToast('Chave Pix copiada!', 'success');
            }).catch(err => {
                console.error('Erro ao copiar a chave Pix:', err);
                showToast('Erro ao copiar. Copie manualmente: ' + pixKey, 'error');
            });
        });


        // =======================================================
        // RENDERIZA√á√ÉO E NAVEGA√á√ÉO DO CAT√ÅLOGO
        // =======================================================
        
        // Render de produtos no Carrossel
        onSnapshot(collection(db,'produtos'), (snapshot)=>{
            if(!produtosTrack) return;
            produtosTrack.innerHTML = '';

            snapshot.forEach(d=>{
                const p = d.data();
                const preco = Number(p.preco)||0;

                const card = document.createElement('div');
                card.className = "prod-card bg-white rounded-xl shadow-lg p-4 flex flex-col items-center hover:shadow-xl transition-all duration-300";

                card.innerHTML = `
                    <div class="w-full aspect-square bg-gray-50 rounded-xl mb-4 overflow-hidden flex items-center justify-center">
                        <img
                            src="${p.imagem || 'https://placehold.co/800'}"
                            alt="${p.nome || ''}"
                            class="max-w-full max-h-full object-contain"
                            loading="lazy"
                            onerror="this.src='https://placehold.co/800'"
                        />
                    </div>
                    <h3 class="text-lg sm:text-xl font-bold mb-1 text-center">${p.nome || 'Produto'}</h3>
                    <p class="text-sm text-gray-500 mb-2 text-center">${p.descricao || ''}</p>
                    <p class="text-base sm:text-lg font-semibold text-blue-600 mb-4">${fmtBRL(preco)}</p>
                    <button class="w-full bg-blue-600 text-white p-3 rounded-lg font-semibold hover:bg-blue-700">
                        Adicionar <i class="fas fa-cart-plus"></i>
                    </button>
                `;
                card.querySelector('button').addEventListener('click', ()=>adicionarAoCarrinho({id:d.id,...p}));
                produtosTrack.appendChild(card);
            });
        });

        // Controles de navega√ß√£o do carrossel
        function scrollAmount(){
            const card = produtosTrack.querySelector('.prod-card');
            return card ? card.getBoundingClientRect().width + 16 : 320; // 16 = gap
        }
        prevBtn?.addEventListener('click', ()=>{
            produtosViewport.scrollBy({left: -scrollAmount(), behavior:'smooth'});
        });
        nextBtn?.addEventListener('click', ()=>{
            produtosViewport.scrollBy({left:  scrollAmount(), behavior:'smooth'});
        });

        // Autoplay suave (pausa ao interagir).
        let autoTimer = setInterval(()=> {
            const viewport = produtosViewport;
            const scrollWidth = viewport.scrollWidth;
            const clientWidth = viewport.clientWidth;
            const currentScroll = viewport.scrollLeft;
            const scrollStep = scrollAmount();

            if (currentScroll + clientWidth >= scrollWidth) {
                // Se chegou ao final, volta para o in√≠cio
                viewport.scrollTo({left: 0, behavior:'smooth'});
            } else {
                viewport.scrollBy({left: scrollStep, behavior:'smooth'});
            }
        }, 4000);
        
        ['mouseenter','touchstart','pointerdown','focusin'].forEach(evt=>{
            produtosViewport.addEventListener(evt, ()=>{ clearInterval(autoTimer); autoTimer=null; }, {passive:true});
        });

    </script>

    <script>
        window.addEventListener('load', () => {
            const splash = document.getElementById('splashScreen');
            const main = document.querySelector('main');
            // Remove a l√≥gica de localStorage 'splashSeen' para garantir que o splash seja exibido a cada carregamento,
            // ou mantenha, dependendo da necessidade exata. Mantendo o comportamento original (uma vez).
            if (localStorage.getItem('splashSeen')) {
                splash.style.display = 'none';
                main.style.display = 'block';
                return;
            }
            localStorage.setItem('splashSeen', 'true');
            setTimeout(() => {
                splash.style.opacity = '0';
                setTimeout(() => {
                    splash.style.display = 'none';
                    main.style.display = 'block';
                }, 1000);
            }, 1500);
        });
    </script>
</body>
</html>
