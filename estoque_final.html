<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Estoque Final Consolidado</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
    h1, h2 { text-align: center; }
    .filters { display: flex; justify-content: center; gap: 20px; margin-bottom: 20px; }
    select, input { padding: 8px; border-radius: 6px; border: 1px solid #ccc; }
    button { padding: 10px 18px; border: none; border-radius: 6px; background: #004AAD; color: #fff; font-weight: bold; cursor: pointer; }
    button:hover { background: #00307A; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; background: #fff; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background: #eee; }
    #expedicoes { margin-top: 40px; }
    .voltar { display:block; margin:20px auto; max-width:200px; text-align:center; text-decoration:none; background:#777; padding:10px 15px; border-radius:6px; color:#fff; font-weight:bold; }
    .voltar:hover { background:#555; }
  </style>
</head>
<body>
  <h1>üì¶ Estoque Final Consolidado</h1>

  <div class="filters">
    <label>Data:
      <input type="date" id="filtroData">
    </label>
    <label>Loja:
      <select id="filtroLoja">
        <option value="todas">Todas</option>
        <option value="centro">Centro</option>
        <option value="planaltina">Planaltina</option>
        <option value="pri">Pri</option>
      </select>
    </label>
    <button onclick="exportar()">‚¨áÔ∏è Exportar Excel/PDF</button>
  </div>

  <h2>Resumo de Estoque</h2>
  <table id="tabelaEstoque">
    <thead>
      <tr>
        <th>Produto</th>
        <th>Estoque Inicial</th>
        <th>Entradas</th>
        <th>Sa√≠das</th>
        <th>Estoque Final</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div id="expedicoes">
    <h2>üöö Expedi√ß√µes</h2>
    <table>
      <thead>
        <tr>
          <th>Data/Hora</th>
          <th>Loja</th>
          <th>Ve√≠culo</th>
          <th>Respons√°vel</th>
          <th>Produtos</th>
        </tr>
      </thead>
      <tbody id="tabelaExpedicoes"></tbody>
    </table>
  </div>

  <a href="admin.html" class="voltar">‚¨ÖÔ∏è Voltar ao Admin</a>

  <!-- Firebase -->
  <script type="module">
    import { db } from "./firebase.js";
    import { collection, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const tabelaEstoque = document.querySelector("#tabelaEstoque tbody");
    const tabelaExpedicoes = document.querySelector("#tabelaExpedicoes");
    const filtroData = document.getElementById("filtroData");
    const filtroLoja = document.getElementById("filtroLoja");

    let estoqueFinal = {};

    function carregarEstoque() {
      tabelaEstoque.innerHTML = "";
      tabelaExpedicoes.innerHTML = "";
      estoqueFinal = {};

      let dataFiltro = filtroData.value || new Date().toISOString().split("T")[0];
      let lojaFiltro = filtroLoja.value;

      // === ESTOQUE MANUAL ===
      const qEstoque = query(collection(db, "estoque"));
      onSnapshot(qEstoque, snap => {
        estoqueFinal = {};

        snap.forEach(docSnap => {
          const dados = docSnap.data();
          if (!dados.data.startsWith(dataFiltro)) return;
          if (lojaFiltro !== "todas" && dados.loja !== lojaFiltro) return;

          dados.registros.forEach(r => {
            if (!estoqueFinal[r.produto]) {
              estoqueFinal[r.produto] = { inicial: 0, entrada: 0, saida: 0, final: 0 };
            }
            estoqueFinal[r.produto].inicial += parseInt(r.inicial) || 0;
            estoqueFinal[r.produto].entrada += parseInt(r.entrada) || 0;
            estoqueFinal[r.produto].saida += parseInt(r.saida) || 0;
            estoqueFinal[r.produto].final += parseInt(r.final) || 0;
          });
        });

        renderTabela();
      });

      // === EXPEDI√á√ïES ===
      const qExped = query(collection(db, "expedicoes"), orderBy("data", "desc"));
      onSnapshot(qExped, snap => {
        tabelaExpedicoes.innerHTML = "";

        snap.forEach(docSnap => {
          const exp = docSnap.data();
          if (!exp.data.startsWith(dataFiltro)) return;
          if (lojaFiltro !== "todas" && exp.loja !== lojaFiltro) return;

          // aplica sa√≠da no estoque
          exp.itens.forEach(item => {
            if (!estoqueFinal[item.produto]) {
              estoqueFinal[item.produto] = { inicial: 0, entrada: 0, saida: 0, final: 0 };
            }
            estoqueFinal[item.produto].saida += item.quantidade;
            estoqueFinal[item.produto].final -= item.quantidade;
          });

          let produtosTxt = exp.itens.map(p => `${p.produto} (${p.quantidade})`).join(", ");
          tabelaExpedicoes.innerHTML += `
            <tr>
              <td>${exp.data} ${exp.hora}</td>
              <td>${exp.loja}</td>
              <td>${exp.veiculo || "-"}</td>
              <td>${exp.responsavel || "-"}</td>
              <td>${produtosTxt}</td>
            </tr>`;
        });

        renderTabela();
      });
    }

    function renderTabela() {
      tabelaEstoque.innerHTML = "";
      for (let produto in estoqueFinal) {
        const r = estoqueFinal[produto];
        tabelaEstoque.innerHTML += `
          <tr>
            <td>${produto}</td>
            <td>${r.inicial}</td>
            <td>${r.entrada}</td>
            <td>${r.saida}</td>
            <td><b>${r.final}</b></td>
          </tr>`;
      }
    }

    filtroData.addEventListener("change", carregarEstoque);
    filtroLoja.addEventListener("change", carregarEstoque);

    window.onload = carregarEstoque;

    window.exportar = function() {
      const conteudo = document.body.innerHTML;
      const win = window.open("", "", "width=900,height=700");
      win.document.write("<html><head><title>Exportar</title></head><body>");
      win.document.write(conteudo);
      win.document.write("</body></html>");
      win.document.close();
      win.print();
    }
  </script>
</body>
</html>
