<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Clientes - Gigas</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">

  <style>
    body{font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:#f0f4f8}
    .toast{position:fixed;bottom:-100px;left:50%;transform:translateX(-50%);padding:12px 20px;border-radius:10px;background:#004AAD;color:#fff;box-shadow:0 10px 25px rgba(0,0,0,.25);font-weight:600;transition:bottom .5s,opacity .5s;opacity:0;z-index:1000}
    .toast.show{bottom:24px;opacity:1}
    .toast.error{background:#e53935}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:16px;box-shadow:0 6px 16px rgba(0,0,0,.06)}
    .hint{font-size:.85rem;color:#6b7280}
    .req::after{content:" *";color:#ef4444;font-weight:700}
    .grid-form{display:grid;gap:12px;grid-template-columns:1fr}
    @media(min-width:768px){.grid-form{grid-template-columns:repeat(2,1fr)}}
    input,select,textarea{border:1px solid #d1d5db;border-radius:10px;padding:12px 14px;width:100%;outline:none}
    input:focus,select:focus,textarea:focus{border-color:#2563eb;box-shadow:0 0 0 3px rgba(37,99,235,.15)}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:12px 16px;border-radius:10px;font-weight:800}
    .btn-primary{background:#004AAD;color:#fff}
    .btn-primary:hover{background:#00307A}
    .btn-secondary{background:#6b7280;color:#fff}
    .btn-secondary:hover{background:#4b5563}
  </style>
</head>
<body>

  <!-- Header -->
  <header class="bg-blue-800 text-white px-4 py-3 md:py-4 shadow-lg">
    <div class="max-w-5xl mx-auto flex items-center justify-between">
      <h1 class="text-lg md:text-2xl font-extrabold flex items-center gap-2">
        <i class="fas fa-users text-yellow-300"></i> Gestão de Clientes
      </h1>
      <a href="index.html" class="btn btn-secondary text-sm md:text-base"><i class="fas fa-arrow-left"></i> Voltar</a>
    </div>
  </header>

  <main class="max-w-5xl mx-auto p-4 md:p-8">
    <!-- Cadastro -->
    <section class="card p-5 md:p-7">
      <h2 class="text-xl md:text-2xl font-extrabold text-blue-800 mb-1">Cadastrar Novo Cliente</h2>
      <p class="hint mb-5">Os cadastros são salvos no banco e não ficam listados nesta tela.</p>

      <form id="clientForm" class="grid-form">
        <!-- Nome e Telefone -->
        <div>
          <label for="nomeCompleto" class="font-semibold req">Nome completo</label>
          <input id="nomeCompleto" type="text" placeholder="Ex.: Maria Oliveira Santos" required />
        </div>
        <div>
          <label for="telefone" class="font-semibold req">Telefone / WhatsApp</label>
          <input id="telefone" type="tel" placeholder="(11) 98765-4321" required />
        </div>

        <!-- CEP + Auto Preenchimento -->
        <div>
          <label for="cep" class="font-semibold req">CEP</label>
          <input id="cep" inputmode="numeric" maxlength="9" placeholder="00000-000" required />
          <p class="hint mt-1">Ao informar o CEP, vamos buscar rua/bairro/cidade/UF automaticamente.</p>
        </div>
        <div>
          <label for="tipo" class="font-semibold req">Tipo do endereço</label>
          <select id="tipo" required>
            <option value="Residencial">Residencial</option>
            <option value="Comercial">Comercial</option>
          </select>
        </div>

        <!-- Endereço detalhado -->
        <div>
          <label for="logradouro" class="font-semibold req">Logradouro (Rua/Avenida)</label>
          <input id="logradouro" type="text" placeholder="Ex.: Rua das Flores" required />
        </div>
        <div>
          <label for="numero" class="font-semibold req">Número</label>
          <input id="numero" type="text" placeholder="Ex.: 123" required />
        </div>

        <div>
          <label for="complemento" class="font-semibold">Complemento (Casa / Apto / Bloco)</label>
          <input id="complemento" type="text" placeholder="Ex.: Apto 12, Bloco B" />
        </div>
        <div>
          <label for="lote" class="font-semibold">Lote</label>
          <input id="lote" type="text" placeholder="Ex.: Lote 15" />
        </div>

        <div>
          <label for="bairroVila" class="font-semibold req">Bairro / Vila</label>
          <input id="bairroVila" type="text" placeholder="Ex.: Vila Nova" required />
        </div>
        <div>
          <label for="cidade" class="font-semibold req">Cidade</label>
          <input id="cidade" type="text" placeholder="Ex.: São Paulo" required />
        </div>

        <div>
          <label for="estado" class="font-semibold req">Estado (UF)</label>
          <input id="estado" type="text" maxlength="2" placeholder="Ex.: SP" required />
        </div>
        <div class="md:col-span-2">
          <label for="observacoes" class="font-semibold">Observações</label>
          <textarea id="observacoes" rows="3" placeholder="Pontos de referência, horários de entrega, etc."></textarea>
        </div>

        <!-- Botões -->
        <div class="md:col-span-2 flex flex-col sm:flex-row gap-2">
          <button type="submit" class="btn btn-primary flex-1"><i class="fas fa-save"></i> Salvar cliente</button>
          <button type="button" id="limparBtn" class="btn flex-1"><i class="fas fa-eraser"></i> Limpar</button>
        </div>
      </form>
    </section>
  </main>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <script type="module">
    // Usa seu firebase.js central
    import { db } from "./firebase.js";
    import { collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    // ===== Helpers UI =====
    const $ = (id) => document.getElementById(id);
    const toastEl = $("toast");
    function showToast(msg, type="success"){
      toastEl.textContent = msg;
      toastEl.classList.remove("error");
      if(type==="error") toastEl.classList.add("error");
      toastEl.classList.add("show");
      setTimeout(()=>{ toastEl.classList.remove("show"); }, 3000);
    }

    // ===== Máscaras (Telefone e CEP) =====
    const telInput = $("telefone");
    telInput.addEventListener("input", () => {
      let v = telInput.value.replace(/\D/g,"").slice(0,11);
      if(v.length > 10){
        // (11) 9XXXX-XXXX
        v = v.replace(/^(\d{2})(\d{1})(\d{4})(\d{4}).*/, "($1) $2$3-$4");
      }else if(v.length > 6){
        // (11) XXXX-XXXX
        v = v.replace(/^(\d{2})(\d{4})(\d{0,4}).*/, "($1) $2-$3");
      }else if(v.length > 2){
        v = v.replace(/^(\d{2})(\d{0,5}).*/, "($1) $2");
      }else{
        v = v.replace(/^(\d{0,2}).*/, "($1");
      }
      telInput.value = v.trim();
    });

    const cepInput = $("cep");
    cepInput.addEventListener("input", () => {
      let v = cepInput.value.replace(/\D/g,"").slice(0,8);
      if(v.length > 5) v = v.replace(/^(\d{5})(\d{0,3}).*/, "$1-$2");
      cepInput.value = v;
    });

    // ===== ViaCEP: autopreencher endereço com CEP =====
    async function buscarCEP(cep){
      try{
        const clean = cep.replace(/\D/g,"");
        if(clean.length !== 8) return;
        const res = await fetch(`https://viacep.com.br/ws/${clean}/json/`);
        if(!res.ok) return;
        const data = await res.json();
        if(data.erro) return;
        // Preenche
        $("logradouro").value = data.logradouro || $("logradouro").value;
        $("bairroVila").value = data.bairro || $("bairroVila").value;
        $("cidade").value = data.localidade || $("cidade").value;
        $("estado").value = data.uf || $("estado").value;
      }catch(e){ /* silencioso */ }
    }
    cepInput.addEventListener("blur", () => buscarCEP(cepInput.value));

    // ===== Submit =====
    const form = $("clientForm");
    const limparBtn = $("limparBtn");

    function requiredOk(){
      const reqIds = ["nomeCompleto","telefone","cep","logradouro","numero","bairroVila","cidade","estado","tipo"];
      for(const id of reqIds){
        const el = $(id);
        if(!el || !el.value || !el.value.trim()){
          el?.focus();
          showToast("Preencha todos os campos obrigatórios.", "error");
          return false;
        }
      }
      // UF com 2 letras
      const uf = $("estado").value.trim().toUpperCase();
      if(uf.length !== 2){ $("estado").focus(); showToast("UF deve ter 2 letras.", "error"); return false; }
      $("estado").value = uf;
      // CEP com 8 dígitos
      if($("cep").value.replace(/\D/g,"").length !== 8){ $("cep").focus(); showToast("CEP inválido.", "error"); return false; }
      return true;
    }

    form.addEventListener("submit", async (e)=>{
      e.preventDefault();
      if(!requiredOk()) return;

      const payload = {
        nomeCompleto: $("nomeCompleto").value.trim(),
        telefone: $("telefone").value.trim(),
        tipo: $("tipo").value,
        endereco: {
          cep: $("cep").value.trim(),
          logradouro: $("logradouro").value.trim(),
          numero: $("numero").value.trim(),
          complemento: $("complemento").value.trim(),
          bairroVila: $("bairroVila").value.trim(),
          lote: $("lote").value.trim(),
          cidade: $("cidade").value.trim(),
          estado: $("estado").value.trim()
        },
        observacoes: $("observacoes").value.trim(),
        criadoEm: serverTimestamp()
      };

      try{
        // Coleção separada para não colidir com "clientes" (usuários)
        await addDoc(collection(db, "clientes_cadastros"), payload);
        showToast("Cliente salvo com sucesso!");
        form.reset();
      }catch(err){
        showToast("Erro ao salvar: " + (err?.message || err), "error");
      }
    });

    limparBtn.addEventListener("click", ()=> form.reset());
  </script>
</body>
</html>
