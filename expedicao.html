<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Expedi√ß√£o - Gigas</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
    h1 { text-align: center; }
    .form-group { margin: 10px 0; }
    input, select, button { padding: 8px; margin: 5px 0; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; background: #fff; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background: #eee; }
    button { background: #004aad; color: #fff; border: none; cursor: pointer; border-radius: 4px; }
    button:hover { background: #00307a; }
    #historico { margin-top: 30px; background: #fff; padding: 10px; border: 1px solid #ccc; }
  </style>
</head>
<body>
  <h1>üöö Controle de Expedi√ß√£o</h1>

  <div class="form-group">
    <label>Loja de Origem:</label>
    <select id="loja">
      <option value="centro">Centro</option>
      <option value="planaltina">Planaltina</option>
      <option value="pri">Pri</option>
    </select>
  </div>

  <div class="form-group">
    <label>Motorista / Estoquista:</label>
    <input type="text" id="responsavel" placeholder="Nome do respons√°vel">
  </div>

  <div class="form-group">
    <label>Ve√≠culo / Placa:</label>
    <input type="text" id="veiculo" placeholder="Ex: Caminh√£o XYZ-1234">
  </div>

  <table id="expedicaoTable">
    <thead>
      <tr>
        <th>Produto</th>
        <th>Quantidade Carregada</th>
      </tr>
    </thead>
    <tbody>
      <tr><td>P13</td><td><input type="number" class="qtd" min="0"></td></tr>
      <tr><td>P20</td><td><input type="number" class="qtd" min="0"></td></tr>
      <tr><td>P45</td><td><input type="number" class="qtd" min="0"></td></tr>
      <tr><td>P5</td><td><input type="number" class="qtd" min="0"></td></tr>
      <tr><td>√Ågua 20L</td><td><input type="number" class="qtd" min="0"></td></tr>
    </tbody>
  </table>

  <div class="form-group">
    <button onclick="registrarExpedicao()">üíæ Registrar Expedi√ß√£o</button>
    <button onclick="verHistorico()">üìú Ver Hist√≥rico</button>
  </div>

  <div id="historico"></div>

  <!-- Firebase -->
  <script type="module">
    import { db } from "./firebase.js";
    import { doc, setDoc, getDoc, updateDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    async function registrarExpedicao() {
      const loja = document.getElementById("loja").value;
      const responsavel = document.getElementById("responsavel").value;
      const veiculo = document.getElementById("veiculo").value;
      const data = new Date().toISOString().split("T")[0];
      const hora = new Date().toLocaleTimeString();

      if (!responsavel || !veiculo) {
        alert("‚ö†Ô∏è Preencha o nome do respons√°vel e o ve√≠culo!");
        return;
      }

      const rows = document.querySelectorAll("#expedicaoTable tbody tr");
      const itens = [];
      rows.forEach(row => {
        const produto = row.cells[0].textContent;
        const qtd = parseInt(row.querySelector(".qtd").value) || 0;
        if (qtd > 0) {
          itens.push({ produto, quantidade: qtd });
        }
      });

      if (itens.length === 0) {
        alert("‚ö†Ô∏è Nenhum produto carregado.");
        return;
      }

      // Salva a expedi√ß√£o
      await setDoc(doc(db, "expedicoes", loja + "_" + data + "_" + hora), {
        loja,
        responsavel,
        veiculo,
        data,
        hora,
        itens
      });

      // Atualiza estoque final (baixa)
      const estoqueFinalRef = doc(db, "estoque-final", data);
      const estoqueFinalSnap = await getDoc(estoqueFinalRef);
      let estoqueFinal = estoqueFinalSnap.exists() ? estoqueFinalSnap.data() : { registros: [] };

      itens.forEach(item => {
        let registro = estoqueFinal.registros.find(r => r.produto === item.produto);
        if (registro) {
          registro.saida = (parseInt(registro.saida) || 0) + item.quantidade;
          registro.final = (parseInt(registro.final) || 0) - item.quantidade;
        } else {
          estoqueFinal.registros.push({
            produto: item.produto,
            inicial: 0,
            entrada: 0,
            saida: item.quantidade,
            final: -item.quantidade
          });
        }
      });

      await setDoc(estoqueFinalRef, estoqueFinal);
      alert("‚úÖ Expedi√ß√£o registrada e estoque final atualizado!");
    }
    window.registrarExpedicao = registrarExpedicao;

    async function verHistorico() {
      const loja = document.getElementById("loja").value;
      const data = new Date().toISOString().split("T")[0];
      const docSnap = await getDoc(doc(db, "expedicoes", loja + "_" + data + "_"));
      const historico = document.getElementById("historico");

      historico.innerHTML = "<h3>üìú Hist√≥rico de Expedi√ß√µes ("+loja+"):</h3>";
      if (docSnap.exists()) {
        historico.innerHTML += "<pre>" + JSON.stringify(docSnap.data(), null, 2) + "</pre>";
      } else {
        historico.innerHTML += "<p>Nenhum registro encontrado.</p>";
      }
    }
    window.verHistorico = verHistorico;
  </script>
</body>
</html>
