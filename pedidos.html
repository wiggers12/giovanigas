<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Pedidos - Gigas Premium</title>

  <!-- Tailwind + PWA -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="manifest" href="./manifest.webmanifest">
  <meta name="theme-color" content="#004AAD">
  <link rel="apple-touch-icon" href="icons/icon-192.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="Gigas">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">

  <!-- Font Awesome -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">

  <style>
    body {
      font-family: 'Inter', sans-serif;
      background-color: #f0f4f8;
    }
    .toast {
      position: fixed;
      bottom: -100px;
      left: 50%;
      transform: translateX(-50%);
      padding: 12px 25px;
      border-radius: 8px;
      background: #3a7dff;
      color: white;
      box-shadow: 0 10px 25px rgba(0,0,0,0.3);
      font-weight: 500;
      transition: bottom 0.5s ease-in-out, opacity 0.5s ease-in-out;
      opacity: 0;
      z-index: 1000;
    }
    .toast.show { bottom: 30px; opacity: 1; }
    .toast.error { background: #e53935; }

    .checkout-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 2rem;
    }
    @media (min-width: 768px) {
      .checkout-grid {
        grid-template-columns: 2fr 1fr;
        align-items: stretch;
      }
    }

    /* Modal PIX */
    .modal-overlay {position:fixed;inset:0;background:rgba(0,0,0,.7);display:none;justify-content:center;align-items:center;z-index:70}
    .modal-overlay.active {display:flex}
    .modal-content {background:#fff;padding:1.25rem;border-radius:1rem;max-width:400px;width:92vw;box-shadow:0 10px 24px rgba(0,0,0,.25)}
    .modal-header {display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
    .modal-header h3 {font-size:1.2rem;font-weight:800}
    .close-btn {background:transparent;border:none;font-size:1.2rem;cursor:pointer}
  </style>
</head>

<body class="bg-gray-100 text-gray-800">

  <header class="bg-blue-800 text-white p-4 text-center font-bold text-xl md:text-2xl shadow-lg">
    <i class="fas fa-receipt text-yellow-300"></i> Meu Pedido
  </header>

  <div class="container mx-auto p-4 md:p-8">
    <div class="checkout-grid">
      <!-- Dados do pedido -->
      <div class="space-y-8">
        <div class="bg-white p-6 rounded-xl shadow-lg">
          <h2 class="text-2xl font-bold text-blue-800 mb-4">
            <i class="fas fa-box"></i> Detalhes do Pedido
          </h2>
          <div id="orderDetails" class="space-y-4"></div>
          <div class="font-bold text-xl mt-4 text-right">
            Total do Pedido: <span id="pedidoTotal">R$ 0,00</span>
          </div>
        </div>

        <div class="bg-white p-6 rounded-xl shadow-lg">
          <h2 class="text-2xl font-bold text-blue-800 mb-4">
            <i class="fas fa-user"></i> Meus Dados
          </h2>
          <div id="clientData" class="space-y-2 text-gray-600">
            <p><strong>Nome:</strong> <span id="clientName">Carregando...</span></p>
            <p><strong>E-mail:</strong> <span id="clientEmail">Carregando...</span></p>
            <p><strong>Endereço:</strong> <span id="clientAddress">Carregando...</span></p>
            <p><strong>Telefone:</strong> <span id="clientPhone">Carregando...</span></p>
          </div>
        </div>

        <div class="bg-white p-6 rounded-xl shadow-lg">
          <h3 class="text-2xl font-bold text-blue-800 mb-4">
            <i class="fas fa-truck"></i> Formas de Entrega
          </h3>
          <div class="space-y-2">
            <label class="flex items-center space-x-2">
              <input type="radio" name="deliveryMethod" value="padrao" checked>
              <span>Entrega Padrão</span>
            </label>
            <label class="flex items-center space-x-2">
              <input type="radio" name="deliveryMethod" value="expresso">
              <span>Entrega Expressa</span>
            </label>
            <label class="flex items-center space-x-2">
              <input type="radio" name="deliveryMethod" value="retirada">
              <span>Retirada na Loja</span>
            </label>
          </div>
        </div>
      </div>

      <!-- Pagamento -->
      <div class="bg-white p-6 rounded-xl shadow-lg h-full flex flex-col justify-between">
        <div>
          <div class="mb-6">
            <h3 class="text-xl font-bold text-blue-800 mb-4">
              <i class="fas fa-credit-card"></i> Formas de Pagamento
            </h3>
            <div class="space-y-2">
              <label class="flex items-center space-x-2">
                <input type="radio" name="paymentMethod" value="pix" checked>
                <span>PIX</span>
              </label>
              <label class="flex items-center space-x-2">
                <input type="radio" name="paymentMethod" value="creditCard">
                <span>Cartão de Crédito</span>
              </label>
              <label class="flex items-center space-x-2">
                <input type="radio" name="paymentMethod" value="boleto">
                <span>Boleto Bancário</span>
              </label>
            </div>
          </div>
        </div>

        <button id="finalizarPedidoBtn" class="w-full bg-green-500 text-white p-4 rounded-lg font-semibold hover:bg-green-600 transition duration-200 shadow-md">
          Finalizar Pedido <i class="fas fa-check-circle"></i>
        </button>
      </div>
    </div>

    <div class="text-center mt-8">
      <a href="index.html" class="inline-block bg-gray-500 text-white font-bold py-3 px-6 rounded-lg shadow-md hover:bg-gray-600 transition duration-200">
        <i class="fas fa-arrow-left"></i> Voltar ao Menu
      </a>
    </div>
  </div>

  <!-- Modal PIX -->
  <div id="pixModal" class="modal-overlay" aria-modal="true" role="dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Pagamento via Pix</h3>
        <button class="close-btn" id="closePixModal"><i class="fas fa-times"></i></button>
      </div>
      <p>Use a chave Pix abaixo para realizar o pagamento:</p>
      <div style="background:#f1f1f1;padding:10px;border-radius:8px;margin-top:10px;display:flex;justify-content:space-between;align-items:center;">
        <span id="pixKeyText" style="font-weight:700">34.052.070/0001-05</span>
        <button id="copyPixKey" class="bg-blue-600 text-white p-2 rounded-lg font-semibold hover:bg-blue-700 transition duration-200" style="padding:6px 10px;font-size:.9em;">Copiar</button>
      </div>
      <p style="margin-top:10px;font-weight:600">Valor Total: <span id="pixValor" class="text-blue-800 font-bold"></span></p>
      <button id="confirmarPagamento" class="w-full bg-green-500 text-white p-3 rounded-lg font-semibold hover:bg-green-600 transition duration-200 mt-3">Já realizei o pagamento</button>
    </div>
  </div>

  <!-- Firebase + Script -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { getFirestore, collection, doc, getDoc, updateDoc, getDocs, query, where, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyC4h0J54TZqT8XXUsPSL3_ABVJQ05yP4Hc",
      authDomain: "giovanigas-d959b.firebaseapp.com",
      projectId: "giovanigas-d959b",
      storageBucket: "giovanigas-d959b.firebasestorage.app",
      messagingSenderId: "728326355548",
      appId: "1:728326355548:web:9dda06e1c1148337618499",
      measurementId: "G-ESHC9P6XGZ"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const orderDetailsEl = document.getElementById('orderDetails');
    const pedidoTotalEl = document.getElementById('pedidoTotal');
    const clientNameEl = document.getElementById('clientName');
    const clientEmailEl = document.getElementById('clientEmail');
    const clientAddressEl = document.getElementById('clientAddress');
    const clientPhoneEl = document.getElementById('clientPhone');
    const finalizarPedidoBtn = document.getElementById('finalizarPedidoBtn');
    const pixModal = document.getElementById('pixModal');
    const closePixModal = document.getElementById('closePixModal');
    const pixKeyText = document.getElementById('pixKeyText');
    const copyPixKey = document.getElementById('copyPixKey');
    const pixValor = document.getElementById('pixValor');
    const confirmarPagamento = document.getElementById('confirmarPagamento');

    let activePedidoId = null;
    let activePedidoTotal = 0;
    let clientPhoneNumber = '';

    const fmtBRL = v => (Number(v)||0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});

    function showToast(message, type='success'){
      const t=document.createElement('div');
      t.className=`toast ${type}`;
      t.textContent=message;
      document.body.appendChild(t);
      setTimeout(()=>{t.classList.add('show');setTimeout(()=>t.remove(),3000)},10);
    }

    function fecharPixModal(){pixModal.classList.remove('active')}
    closePixModal.addEventListener('click', fecharPixModal);
    pixModal.addEventListener('click', e=>{if(e.target===pixModal)fecharPixModal();});
    copyPixKey.addEventListener('click', ()=>navigator.clipboard.writeText(pixKeyText.textContent).then(()=>showToast('Chave Pix copiada!')).catch(()=>showToast('Erro ao copiar','error')));

    onAuthStateChanged(auth, async user=>{
      if(!user){showToast('Faça login novamente','error');setTimeout(()=>window.location.href='index.html',2000);return;}
      const clientDoc=await getDoc(doc(db,'clientes',user.uid));
      if(!clientDoc.exists()){showToast('Cliente não encontrado','error');return;}
      const data=clientDoc.data();
      clientNameEl.textContent=data.nome||'Não informado';
      clientEmailEl.textContent=data.email||'Não informado';
      clientPhoneNumber=data.telefone||'';
      clientPhoneEl.textContent=data.telefone||'Não informado';
      clientAddressEl.textContent=data.endereco?`${data.endereco.logradouro}, ${data.endereco.numero}`:'Não informado';

      const q=query(collection(db,'pedidos'),where('userid','==',user.uid),where('status','in',['pendente','aguardando_pagamento_pix']));
      const snapshot=await getDocs(q);
      if(snapshot.empty){orderDetailsEl.innerHTML='<p class="text-center text-gray-500">Nenhum pedido pendente.</p>';return;}
      const pedidoDoc=snapshot.docs[0];
      activePedidoId=pedidoDoc.id;
      const pedido=pedidoDoc.data();
      activePedidoTotal=pedido.total;

      pedido.itens.forEach(item=>{
        const el=document.createElement('div');
        el.className='flex justify-between items-center';
        el.innerHTML=`<span>${item.nome} (${item.qty})</span><span>${fmtBRL(item.preco*item.qty)}</span>`;
        orderDetailsEl.appendChild(el);
      });
      pedidoTotalEl.textContent=fmtBRL(activePedidoTotal);

      finalizarPedidoBtn.addEventListener('click',async()=>{
        pixValor.textContent=fmtBRL(activePedidoTotal);
        pixModal.classList.add('active');
      });

      confirmarPagamento.addEventListener('click',async()=>{
        if(!activePedidoId){showToast('Nenhum pedido ativo.','error');return;}
        confirmarPagamento.disabled=true;
        confirmarPagamento.textContent='Confirmando...';
        try{
          await updateDoc(doc(db,'pedidos',activePedidoId),{status:'pago',confirmadoEm:serverTimestamp()});
          showToast('Pagamento confirmado!','success');

          const nomeCliente=clientNameEl.textContent.split(' ')[0]||'cliente';
          const totalFormatado=fmtBRL(activePedidoTotal);
          const msg=`✅ Olá, ${nomeCliente}!%0ARecebemos o pagamento do seu pedido *GIGAS* no valor de *${totalFormatado}*.%0AObrigado pela preferência 💙%0AAssim que estiver pronto, entraremos em contato.`;
          const telefoneLoja='5551989378751';
          const targetPhone=clientPhoneNumber?clientPhoneNumber.replace(/\D/g,''):telefoneLoja;
          const link=`https://wa.me/55${targetPhone}?text=${msg}`;
          window.open(link,'_blank');

          setTimeout(()=>{pixModal.classList.remove('active');window.location.href='index.html';},3500);
        }catch(e){console.error(e);showToast('Erro ao confirmar pagamento','error');}
        finally{confirmarPagamento.disabled=false;confirmarPagamento.textContent='Já realizei o pagamento';}
      });
    });
  </script>
</body>
</html>
